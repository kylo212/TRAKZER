<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map - Trakzer App</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
  <header>
    <div id="logo">
      <h1>Trakzer</h1>
    </div>
    <nav>
      <ul>
        <li><a href="/map">Map</a></li>
        <li><a href="/dm">Direct Messages</a></li>
        <li><a href="#" id="logout-link">Logout</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <div id="map" style="height: 80vh;"></div>
  </main>

  <footer>
    <p>&copy; 2025 Trakzer App</p>
  </footer>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/login';
    }

    document.getElementById('logout-link').addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.href = '/login';
    });

    const map = L.map('map').setView([51.505, -0.09], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    navigator.geolocation.getCurrentPosition(function(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      const userMarker = L.marker([lat, lng]).addTo(map)
        .bindPopup('Your Location')
        .openPopup();

      map.setView([lat, lng], 13);

      fetch('/api/save-location', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ lat, lng })
      })
      .then(response => response.json())
      .then(data => console.log('Location saved:', data))
      .catch(error => console.error('Error:', error));
    });

    fetch('/api/get-locations', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(response => response.json())
    .then(locations => {
      locations.forEach(location => {
        L.marker([location.lat, location.lng])
          .addTo(map)
          .bindPopup(`${location.name}'s Location`);
      });
    })
    .catch(error => console.error('Error:', error));
  </script>
</body>
</html>
